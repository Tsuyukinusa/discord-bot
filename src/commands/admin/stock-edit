import {
    SlashCommandBuilder,
    PermissionFlagsBits,
    EmbedBuilder
} from "discord.js";
import { readGuildDB, writeGuildDB } from "../../utils/file.js";

export default {
    data: new SlashCommandBuilder()
        .setName("stock-edit")
        .setDescription("æ ªã®è¨­å®šã‚’ç·¨é›†ã—ã¾ã™ï¼ˆç®¡ç†è€…å°‚ç”¨ï¼‰")
        .setDefaultMemberPermissions(PermissionFlagsBits.ManageGuild)

        // æ ªåå¤‰æ›´
        .addSubcommand(sub =>
            sub.setName("name")
                .setDescription("æ ªã®åå‰ã‚’å¤‰æ›´ã—ã¾ã™")
                .addStringOption(opt =>
                    opt.setName("id")
                        .setDescription("æ ªID")
                        .setRequired(true)
                )
                .addStringOption(opt =>
                    opt.setName("newname")
                        .setDescription("æ–°ã—ã„æ ªå¼ä¼šç¤¾å")
                        .setRequired(true)
                )
        )

        // å¤‰å‹•ç‡å¤‰æ›´
        .addSubcommand(sub =>
            sub.setName("volatility")
                .setDescription("æ ªä¾¡å¤‰å‹•ç‡ã‚’å¤‰æ›´ã—ã¾ã™")
                .addStringOption(opt =>
                    opt.setName("id")
                        .setDescription("æ ªID")
                        .setRequired(true)
                )
                .addIntegerOption(opt =>
                    opt.setName("rate")
                        .setDescription("å¤‰å‹•ç‡ï¼ˆÂ±%ï¼‰")
                        .setRequired(true)
                        .setMinValue(0)
                )
        ),

    async execute(interaction) {
        const guildId = interaction.guild.id;
        const sub = interaction.options.getSubcommand();

        const db = await readGuildDB();
        if (!db[guildId] || !db[guildId].stocks) {
            return interaction.reply({
                content: "âŒ æ ªãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚",
                ephemeral: true
            });
        }

        const stockId = interaction.options.getString("id");
        const stock = db[guildId].stocks[stockId];

        if (!stock) {
            return interaction.reply({
                content: "âŒ æŒ‡å®šã•ã‚ŒãŸæ ªIDã¯å­˜åœ¨ã—ã¾ã›ã‚“ã€‚",
                ephemeral: true
            });
        }

        const embed = new EmbedBuilder()
            .setColor("#4b9aff")
            .setTitle("ğŸ“ˆ æ ªè¨­å®šã‚’æ›´æ–°ã—ã¾ã—ãŸ");

        // --- æ ªåå¤‰æ›´ ---
        if (sub === "name") {
            const newName = interaction.options.getString("newname");
            const oldName = stock.name;

            stock.name = newName;

            embed.addFields(
                { name: "æ ªID", value: stockId },
                { name: "æ—§åç§°", value: oldName },
                { name: "æ–°åç§°", value: newName }
            );
        }

        // --- å¤‰å‹•ç‡å¤‰æ›´ ---
        if (sub === "volatility") {
            const rate = interaction.options.getInteger("rate");
            const oldRate = stock.volatility;

            stock.volatility = rate;

            embed.addFields(
                { name: "æ ªID", value: stockId },
                { name: "æ—§å¤‰å‹•ç‡", value: `Â±${oldRate}%` },
                { name: "æ–°å¤‰å‹•ç‡", value: `Â±${rate}%` }
            );
        }

        await writeGuildDB(db);

        return interaction.reply({
            embeds: [embed],
            ephemeral: true // â† ç®¡ç†ç³»ãªã®ã§è‡ªåˆ†ã ã‘
        });
    }
};
