// commands/admin/stock-time-add.js
import { SlashCommandBuilder, EmbedBuilder, PermissionFlagsBits } from "discord.js";
import { readGuildDB, writeGuildDB } from "../../utils/file.js";

export default {
  data: new SlashCommandBuilder()
    .setName("stock-time-add")
    .setDescription("株価変動時間を追加します（管理者専用）")
    .setDefaultMemberPermissions(PermissionFlagsBits.Administrator)
    .addStringOption(o =>
      o.setName("time")
        .setDescription("変動時間（HH:MM）")
        .setRequired(true)
    ),

  async execute(interaction) {
    const guildId = interaction.guild.id;
    const time = interaction.options.getString("time");

    // HH:MM チェック
    if (!/^\d{2}:\d{2}$/.test(time)) {
      return interaction.reply({ content: "❌ 時刻は HH:MM 形式で指定してください。", ephemeral: true });
    }

    const db = await readGuildDB();
    if (!db[guildId]) db[guildId] = {};
    if (!db[guildId].stockConfig) {
      db[guildId].stockConfig = { updateTimes: [], lastRun: null };
    }

    const times = db[guildId].stockConfig.updateTimes;

    if (times.includes(time)) {
      return interaction.reply({ content: "⚠️ その時間は既に登録されています。", ephemeral: true });
    }

    times.push(time);
    times.sort();

    await writeGuildDB(db);

    const embed = new EmbedBuilder()
      .setColor("#4b9aff")
      .setTitle("⏰ 株価変動時間 追加")
      .setDescription(`**${time}** を追加しました。`)
      .addFields({ name: "現在の設定", value: times.join(", ") });

    return interaction.reply({ embeds: [embed], ephemeral: true });
  }
};
