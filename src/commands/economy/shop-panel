import { SlashCommandBuilder, EmbedBuilder, ActionRowBuilder, ButtonBuilder, ButtonStyle } from "discord.js";
import { readGuildDB } from "../../utils/file.js";

export default {
    data: new SlashCommandBuilder()
        .setName("shop-panel")
        .setDescription("ã“ã®ãƒãƒ£ãƒ³ãƒãƒ«ã«ã‚¢ã‚¤ãƒ†ãƒ ã‚·ãƒ§ãƒƒãƒ—ã‚’è¡¨ç¤ºã—ã¾ã™"),

    async execute(interaction) {
        const guildId = interaction.guild.id;
        const db = await readGuildDB();
        const shopIds = db[guildId].shopItems || [];
        const items = db[guildId].items || {};

        const embed = new EmbedBuilder()
            .setTitle("ğŸ›’ ã‚¢ã‚¤ãƒ†ãƒ ã‚·ãƒ§ãƒƒãƒ—")
            .setColor("#00aaff");

        let description = "";

        for (const id of shopIds) {
            const item = items[id];
            if (!item) continue;

            description +=
                `**${item.name}**\n` +
                `ğŸ’´ **${item.sellPrice}**\n` +
                `ğŸ“¦ åœ¨åº«ï¼š**${item.stock ?? 0}**\n` +
                `â €\n`; // â† ä½™ç™½
        }

        embed.setDescription(description || "ç¾åœ¨ã‚·ãƒ§ãƒƒãƒ—ã«å•†å“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");

        // 20ã‚¢ã‚¤ãƒ†ãƒ  â†’ 20å€‹ã®ãƒœã‚¿ãƒ³ã‚’è‡ªå‹•ç”Ÿæˆ
        const rows = [];
        let row = new ActionRowBuilder();

        for (let i = 0; i < shopIds.length; i++) {
            const id = shopIds[i];

            // ãƒœã‚¿ãƒ³
            row.addComponents(
                new ButtonBuilder()
                    .setCustomId(`buy_${id}`)
                    .setLabel(items[id].name)
                    .setStyle(ButtonStyle.Primary)
            );

            // ãƒœã‚¿ãƒ³ã¯1è¡Œ5ã¤ã¾ã§
            if ((i + 1) % 5 === 0) {
                rows.push(row);
                row = new ActionRowBuilder();
            }
        }

        if (row.components.length > 0) rows.push(row);

        await interaction.reply({
            embeds: [embed],
            components: rows
        });
    }
};
