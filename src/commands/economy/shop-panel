import {
    SlashCommandBuilder,
    EmbedBuilder,
    ActionRowBuilder,
    StringSelectMenuBuilder
} from "discord.js";
import { readGuildDB, writeGuildDB } from "../../utils/file.js";

export default {
    data: new SlashCommandBuilder()
        .setName("shop-panel")
        .setDescription("ã‚·ãƒ§ãƒƒãƒ—ãƒ‘ãƒãƒ«ã‚’ä½œæˆã—ã¾ã™ï¼ˆæœ€å¤§ 20 ã‚¢ã‚¤ãƒ†ãƒ ï¼‰"),

    async execute(interaction) {
        const guildId = interaction.guild.id;
        const channelId = interaction.channel.id;

        const db = await readGuildDB();
        if (!db[guildId]) db[guildId] = {};
        if (!db[guildId].items) db[guildId].items = {};
        if (!db[guildId].shopPanels) db[guildId].shopPanels = {};

        const items = db[guildId].items;

        // ã‚¢ã‚¤ãƒ†ãƒ ãŒå­˜åœ¨ã—ãªã„å ´åˆ
        if (Object.keys(items).length === 0) {
            return interaction.reply({
                content: "âŒ ã¾ã ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã« `/item create` ã§ä½œæˆã—ã¦ãã ã•ã„ã€‚",
                ephemeral: true
            });
        }

        // --- ã‚¢ã‚¤ãƒ†ãƒ é¸æŠãƒ¡ãƒ‹ãƒ¥ãƒ¼ ---
        const menu = new StringSelectMenuBuilder()
            .setCustomId("shop-panel-select")
            .setPlaceholder("ã‚·ãƒ§ãƒƒãƒ—ã«ä¸¦ã¹ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸ã‚“ã§ãã ã•ã„ï¼ˆæœ€å¤§20å€‹ï¼‰")
            .setMinValues(1)
            .setMaxValues(Math.min(20, Object.keys(items).length))
            .addOptions(
                Object.entries(items).map(([id, item]) => ({
                    label: item.name,
                    value: id,
                    description: `åœ¨åº«: ${item.stock ?? 0}`,
                }))
            );

        const row = new ActionRowBuilder().addComponents(menu);

        // --- è¿”ä¿¡ï¼ˆé¸æŠå¾…ã¡ï¼‰ ---
        await interaction.reply({
            content: "ğŸ›’ **ã‚·ãƒ§ãƒƒãƒ—ã«ä¸¦ã¹ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸ã‚“ã§ãã ã•ã„ï¼**",
            components: [row],
            ephemeral: true
        });
    }
};
